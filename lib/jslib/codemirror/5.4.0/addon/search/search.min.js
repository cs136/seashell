(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],a)}else{a(CodeMirror)}}})(function(e){function a(s,r){if(typeof s=="string"){s=new RegExp(s.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),r?"gi":"g")}else{if(!s.global){s=new RegExp(s.source,s.ignoreCase?"gi":"g")}}return{token:function(u){s.lastIndex=u.pos;var t=s.exec(u.string);if(t&&t.index==u.pos){u.pos+=t[0].length;return"searching"}else{if(t){u.pos=t.index}else{u.skipToEnd()}}}}}function m(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function h(r){return r.state.search||(r.state.search=new m())}function q(r){return typeof r=="string"&&r==r.toLowerCase()}function o(r,s,t){return r.getSearchCursor(s,t,q(s))}function l(r,u,s,v,t){if(r.openDialog){r.openDialog(u,t,{value:v,selectValueOnOpen:true})}else{t(prompt(s,v))}}function p(s,u,t,r){if(s.openConfirm){s.openConfirm(u,r)}else{if(confirm(t)){r[0]()}}}function d(s){var r=s.match(/^\/(.*)\/([a-z]*)$/);if(r){try{s=new RegExp(r[1],r[2].indexOf("i")==-1?"":"i")}catch(t){}}if(typeof s=="string"?s=="":s.test("")){s=/x^/}return s}var c='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function k(r,s){var u=h(r);if(u.query){return i(r,s)}var t=r.getSelection()||u.lastQuery;l(r,c,"Search for:",t,function(v){r.operation(function(){if(!v||u.query){return}u.query=d(v);r.removeOverlay(u.overlay,q(u.query));u.overlay=a(u.query,q(u.query));r.addOverlay(u.overlay);if(r.showMatchesOnScrollbar){if(u.annotate){u.annotate.clear();u.annotate=null}u.annotate=r.showMatchesOnScrollbar(u.query,q(u.query))}u.posFrom=u.posTo=r.getCursor();i(r,s)})})}function i(r,s){r.operation(function(){var t=h(r);var u=o(r,t.query,s?t.posFrom:t.posTo);if(!u.find(s)){u=o(r,t.query,s?e.Pos(r.lastLine()):e.Pos(r.firstLine(),0));if(!u.find(s)){return}}r.setSelection(u.from(),u.to());r.scrollIntoView({from:u.from(),to:u.to()});t.posFrom=u.from();t.posTo=u.to()})}function n(r){r.operation(function(){var s=h(r);s.lastQuery=s.query;if(!s.query){return}s.query=null;r.removeOverlay(s.overlay);if(s.annotate){s.annotate.clear();s.annotate=null}})}var g='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';var j='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>';var f="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";function b(r,s){if(r.getOption("readOnly")){return}var t=r.getSelection()||h(r).lastQuery;l(r,g,"Replace:",t,function(u){if(!u){return}u=d(u);l(r,j,"Replace with:","",function(y){if(s){r.operation(function(){for(var A=o(r,u);A.findNext();){if(typeof u!="string"){var z=r.getRange(A.from(),A.to()).match(u);A.replace(y.replace(/\$(\d)/g,function(B,C){return z[C]}))}else{A.replace(y)}}})}else{n(r);var x=o(r,u,r.getCursor());var w=function(){var A=x.from(),z;if(!(z=x.findNext())){x=o(r,u);if(!(z=x.findNext())||(A&&x.from().line==A.line&&x.from().ch==A.ch)){return}}r.setSelection(x.from(),x.to());r.scrollIntoView({from:x.from(),to:x.to()});p(r,f,"Replace?",[function(){v(z)},w])};var v=function(z){x.replace(typeof u=="string"?y:y.replace(/\$(\d)/g,function(A,B){return z[B]}));w()};w()}})})}e.commands.find=function(r){n(r);k(r)};e.commands.findNext=k;e.commands.findPrev=function(r){k(r,true)};e.commands.clearSearch=n;e.commands.replace=b;e.commands.replaceAll=function(r){b(r,true)}});